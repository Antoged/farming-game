<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåæ –§–µ—Ä–º–µ—Ä—Å–∫–∞—è –∏–≥—Ä–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .header {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .stat {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            margin: 10px;
            min-width: 120px;
        }
        
        .farm-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
        }
        
        .plot {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .plot:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .plot.empty {
            background: rgba(139, 69, 19, 0.3);
            border-color: #8B4513;
        }
        
        .plot.growing {
            background: rgba(34, 139, 34, 0.3);
            border-color: #228B22;
        }
        
        .plot.ready {
            background: rgba(255, 215, 0, 0.3);
            border-color: #FFD700;
        }
        
        .shop {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            margin: 20px auto;
            max-width: 800px;
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .shop-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            font-size: 14px;
        }
        
        .btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .weather {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            margin: 20px auto;
            max-width: 400px;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
        }
        
        .error {
            background: rgba(255, 0, 0, 0.2);
            color: #ffcccc;
            padding: 15px;
            border-radius: 15px;
            margin: 20px auto;
            max-width: 600px;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .farm-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 10px;
            }
            
            .stats {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üåæ –§–µ—Ä–º–µ—Ä—Å–∫–∞—è –∏–≥—Ä–∞</h1>
        <p>–í—ã—Ä–∞—â–∏–≤–∞–π—Ç–µ —É—Ä–æ–∂–∞–π –∏ —Ä–∞–∑–≤–∏–≤–∞–π—Ç–µ —Å–≤–æ—é —Ñ–µ—Ä–º—É!</p>
    </div>
    
    <div class="stats">
        <div class="stat">
            <h3>üí∞ –ú–æ–Ω–µ—Ç—ã</h3>
            <p id="money">0</p>
        </div>
        <div class="stat">
            <h3>üìä –£—Ä–æ–≤–µ–Ω—å</h3>
            <p id="level">1</p>
        </div>
        <div class="stat">
            <h3>üå± –û–ø—ã—Ç</h3>
            <p id="experience">0</p>
        </div>
    </div>
    
    <div class="weather">
        <h3>üå§Ô∏è –ü–æ–≥–æ–¥–∞</h3>
        <p id="weather-info">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>
    
    <div class="farm-grid" id="farm-grid">
        <div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–µ—Ä–º—ã...</div>
    </div>
    
    <div class="shop">
        <h3>üõí –ú–∞–≥–∞–∑–∏–Ω —Å–µ–º—è–Ω</h3>
        <div class="shop-items" id="shop-items">
            <div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞...</div>
        </div>
    </div>
    
    <script>
        let currentUser = null;
        let farmData = null;
        let shopData = null;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        async function initGame() {
            try {
                // –ü–æ–ª—É—á–∞–µ–º user_id –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π
                const urlParams = new URLSearchParams(window.location.search);
                let userId = urlParams.get('user_id');
                
                if (!userId) {
                    userId = 'browser_' + Math.random().toString(36).substr(2, 9);
                }
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const response = await fetch('/api/init', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        username: '–ò–≥—Ä–æ–∫'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.player;
                    updateStats();
                    loadFarm();
                    loadShop();
                    loadWeather();
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats() {
            if (currentUser) {
                document.getElementById('money').textContent = currentUser.money;
                document.getElementById('level').textContent = currentUser.level;
                document.getElementById('experience').textContent = currentUser.experience || 0;
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–µ—Ä–º—ã
        async function loadFarm() {
            try {
                const response = await fetch(`/api/farm?user_id=${currentUser.id}`);
                if (response.ok) {
                    const data = await response.json();
                    farmData = data.farm;
                    renderFarm();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–µ—Ä–º—ã:', error);
            }
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ñ–µ—Ä–º—ã
        function renderFarm() {
            const farmGrid = document.getElementById('farm-grid');
            farmGrid.innerHTML = '';
            
            if (!farmData || !farmData.plots) {
                farmGrid.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–µ—Ä–º—ã</div>';
                return;
            }
            
            farmData.plots.forEach((plot, index) => {
                const plotDiv = document.createElement('div');
                plotDiv.className = `plot ${plot.status}`;
                
                if (plot.status === 'empty') {
                    plotDiv.innerHTML = `
                        <div>üå± –£—á–∞—Å—Ç–æ–∫ ${index + 1}</div>
                        <div>–ü—É—Å—Ç–æ–π</div>
                        <button class="btn" onclick="showPlantMenu(${index})">–ü–æ—Å–∞–¥–∏—Ç—å</button>
                    `;
                } else if (plot.status === 'growing') {
                    const progress = Math.min(100, (Date.now() - plot.planted_at) / (plot.growth_time * 1000) * 100);
                    plotDiv.innerHTML = `
                        <div>${plot.seed_emoji}</div>
                        <div>${plot.seed_name}</div>
                        <div>–†–∞—Å—Ç–µ—Ç: ${Math.round(progress)}%</div>
                        <div class="progress-bar">
                            <div class="progress" style="width: ${progress}%"></div>
                        </div>
                    `;
                } else if (plot.status === 'ready') {
                    plotDiv.innerHTML = `
                        <div>${plot.seed_emoji}</div>
                        <div>${plot.seed_name}</div>
                        <div>–ì–æ—Ç–æ–≤ –∫ —Å–±–æ—Ä—É!</div>
                        <button class="btn" onclick="harvestPlot(${index})">–°–æ–±—Ä–∞—Ç—å</button>
                    `;
                }
                
                farmGrid.appendChild(plotDiv);
            });
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞
        async function loadShop() {
            try {
                const response = await fetch('/api/shop');
                if (response.ok) {
                    const data = await response.json();
                    shopData = data.items;
                    renderShop();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞:', error);
            }
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞
        function renderShop() {
            const shopItems = document.getElementById('shop-items');
            shopItems.innerHTML = '';
            
            if (!shopData || shopData.length === 0) {
                shopItems.innerHTML = '<div class="error">–ú–∞–≥–∞–∑–∏–Ω –ø—É—Å—Ç</div>';
                return;
            }
            
            shopData.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shop-item';
                itemDiv.innerHTML = `
                    <div style="font-size: 48px;">${item.emoji}</div>
                    <h4>${item.name}</h4>
                    <p>–¶–µ–Ω–∞: ${item.price} üí∞</p>
                    <p>–í—Ä–µ–º—è —Ä–æ—Å—Ç–∞: ${item.growth_time} —Å–µ–∫</p>
                    <button class="btn" onclick="buySeed('${item.type}')" 
                            ${currentUser.money < item.price ? 'disabled' : ''}>
                        –ö—É–ø–∏—Ç—å –∑–∞ ${item.price} üí∞
                    </button>
                `;
                shopItems.appendChild(itemDiv);
            });
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–≥–æ–¥—ã
        async function loadWeather() {
            try {
                const response = await fetch(`/api/farm?user_id=${currentUser.id}`);
                if (response.ok) {
                    const data = await response.json();
                    const weatherInfo = data.weather;
                    document.getElementById('weather-info').innerHTML = `
                        ${weatherInfo.emoji} ${weatherInfo.name}<br>
                        <small>–í–ª–∏—è–Ω–∏–µ: ${weatherInfo.effect_description}</small>
                    `;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–≥–æ–¥—ã:', error);
            }
        }
        
        // –ü–æ–∫—É–ø–∫–∞ —Å–µ–º—è–Ω
        async function buySeed(seedType) {
            try {
                const response = await fetch('/api/buy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        seed_type: seedType
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        alert(data.message);
                        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                        loadShop();
                        updateStats();
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + data.message);
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏ —Å–µ–º—è–Ω:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏ —Å–µ–º—è–Ω');
            }
        }
        
        // –ü–æ–∫–∞–∑ –º–µ–Ω—é –ø–æ—Å–∞–¥–∫–∏
        function showPlantMenu(plotIndex) {
            if (!shopData || shopData.length === 0) {
                alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ–º—è–Ω –¥–ª—è –ø–æ—Å–∞–¥–∫–∏');
                return;
            }
            
            const seedOptions = shopData.map(item => 
                `${item.emoji} ${item.name} (${item.price} üí∞)`
            ).join('\n');
            
            const seedType = prompt(
                `–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–º—è –¥–ª—è –ø–æ—Å–∞–¥–∫–∏ –Ω–∞ —É—á–∞—Å—Ç–æ–∫ ${plotIndex + 1}:\n\n${seedOptions}\n\n–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–µ–º–µ–Ω–∏:`
            );
            
            if (seedType) {
                const selectedSeed = shopData.find(item => 
                    item.name.toLowerCase().includes(seedType.toLowerCase()) ||
                    item.type === seedType
                );
                
                if (selectedSeed) {
                    plantSeed(plotIndex, selectedSeed.type);
                } else {
                    alert('–°–µ–º—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                }
            }
        }
        
        // –ü–æ—Å–∞–¥–∫–∞ —Å–µ–º—è–Ω
        async function plantSeed(plotIndex, seedType) {
            try {
                const response = await fetch('/api/plant', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        plot_id: plotIndex,
                        seed_type: seedType
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        alert(data.message);
                        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                        loadFarm();
                        loadShop();
                        updateStats();
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + data.message);
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ—Å–∞–¥–∫–∏ —Å–µ–º—è–Ω:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ—Å–∞–¥–∫–∏ —Å–µ–º—è–Ω');
            }
        }
        
        // –°–±–æ—Ä —É—Ä–æ–∂–∞—è
        async function harvestPlot(plotIndex) {
            try {
                const response = await fetch('/api/harvest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        plot_id: plotIndex
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        alert(data.message);
                        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                        loadFarm();
                        loadShop();
                        updateStats();
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + data.message);
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–±–æ—Ä–∞ —É—Ä–æ–∂–∞—è:', error);
                alert('–û—à–∏–±–∫–∞ —Å–±–æ—Ä–∞ —É—Ä–æ–∂–∞—è');
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.body.insertBefore(errorDiv, document.body.firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }
        
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            if (currentUser) {
                loadFarm();
                loadWeather();
            }
        }, 5000);
        
        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>

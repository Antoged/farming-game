<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåæ Farming Game</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
        }

        .weather-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 8px;
            padding: 4px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .tab.active {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .content {
            min-height: 400px;
        }

        .farm-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .plot {
            aspect-ratio: 1;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .plot:hover {
            background: var(--tg-theme-hint-color, #999999);
        }

        .plot.planted {
            background: #4CAF50;
            color: white;
        }

        .plot.ready {
            background: #FF9800;
            color: white;
            animation: pulse 1s infinite;
        }

        .plot-info {
            font-size: 12px;
            text-align: center;
        }

        .shop-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .shop-item {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        .shop-item button {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 8px;
        }

        .inventory-items {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .inventory-item {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        .inventory-item button {
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--tg-theme-hint-color, #999999);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .error {
            color: #f44336;
            text-align: center;
            padding: 20px;
        }

        .success {
            color: #4CAF50;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üåæ –§–µ—Ä–º–µ—Ä—Å–∫–∞—è –ò–≥—Ä–∞</h1>
        <div class="weather-info">
            <span id="weather-emoji">üå§Ô∏è</span>
            <span id="weather-text">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–≥–æ–¥—ã...</span>
        </div>
    </div>

    <div class="stats">
        <div class="stat-card">
            <div>üí∞ –ú–æ–Ω–µ—Ç—ã</div>
            <div id="money">0</div>
        </div>
        <div class="stat-card">
            <div>üìä –£—Ä–æ–≤–µ–Ω—å</div>
            <div id="level">1</div>
        </div>
        <div class="stat-card">
            <div>üì¶ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
            <div id="inventory-count">0</div>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('farm')">üå± –§–µ—Ä–º–∞</div>
        <div class="tab" onclick="switchTab('shop')">üõí –ú–∞–≥–∞–∑–∏–Ω</div>
        <div class="tab" onclick="switchTab('inventory')">üì¶ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
    </div>

    <div class="content">
        <!-- –§–µ—Ä–º–∞ -->
        <div id="farm-content" class="tab-content">
            <div class="farm-grid" id="farm-grid">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–µ—Ä–º—ã...</div>
            </div>
        </div>

        <!-- –ú–∞–≥–∞–∑–∏–Ω -->
        <div id="shop-content" class="tab-content" style="display: none;">
            <div class="shop-items" id="shop-items">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞...</div>
            </div>
        </div>

        <!-- –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å -->
        <div id="inventory-content" class="tab-content" style="display: none;">
            <div class="inventory-items" id="inventory-items">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è...</div>
            </div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // –ü–æ–ª—É—á–µ–Ω–∏–µ user_id –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('user_id');

        if (!userId) {
            document.body.innerHTML = '<div class="error">–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω user_id</div>';
        }

        let currentTab = 'farm';

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tabName) {
            currentTab = tabName;
            
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.getElementById(tabName + '-content').style.display = 'block';
            
            // –û–±–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
            switch(tabName) {
                case 'farm':
                    loadFarm();
                    break;
                case 'shop':
                    loadShop();
                    break;
                case 'inventory':
                    loadInventory();
                    break;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–µ—Ä–º—ã
        async function loadFarm() {
            try {
                const response = await fetch(`/api/farm?user_id=${userId}`);
                const farmData = await response.json();
                
                if (farmData.error) {
                    document.getElementById('farm-grid').innerHTML = `<div class="error">${farmData.error}</div>`;
                    return;
                }
                
                const farmGrid = document.getElementById('farm-grid');
                farmGrid.innerHTML = '';
                
                farmData.plots.forEach((plot, index) => {
                    const plotElement = document.createElement('div');
                    plotElement.className = `plot ${plot.status}`;
                    plotElement.onclick = () => handlePlotClick(index);
                    
                    let plotContent = '';
                    if (plot.status === 'empty') {
                        plotContent = 'üå±';
                    } else if (plot.status === 'planted') {
                        plotContent = 'üåø';
                    } else if (plot.status === 'ready') {
                        plotContent = 'üåæ';
                    }
                    
                    plotElement.innerHTML = `
                        <div class="plot-info">
                            ${plotContent}
                            ${plot.status === 'planted' ? `<br><small>${plot.timeLeft}s</small>` : ''}
                        </div>
                    `;
                    
                    farmGrid.appendChild(plotElement);
                });
            } catch (error) {
                document.getElementById('farm-grid').innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–µ—Ä–º—ã</div>';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ —É—á–∞—Å—Ç–∫—É
        async function handlePlotClick(plotId) {
            try {
                const plots = await fetch(`/api/farm?user_id=${userId}`).then(r => r.json());
                const plot = plots.plots[plotId];
                
                if (plot.status === 'empty') {
                    // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±–æ—Ä —Å–µ–º—è–Ω
                    const seedType = prompt('–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–º–µ–Ω–∞ –¥–ª—è –ø–æ—Å–∞–¥–∫–∏:\n1. –ú–æ—Ä–∫–æ–≤—å\n2. –ü–æ–º–∏–¥–æ—Ä\n3. –ö–∞—Ä—Ç–æ—à–∫–∞\n4. –û–≥—É—Ä–µ—Ü\n5. –ö–ª—É–±–Ω–∏–∫–∞\n6. –ê—Ä–±—É–∑\n7. –ó–æ–ª–æ—Ç–æ–µ —è–±–ª–æ–∫–æ');
                    
                    if (seedType) {
                        const seedMap = {
                            '1': 'carrot', '2': 'tomato', '3': 'potato', '4': 'cucumber',
                            '5': 'strawberry', '6': 'watermelon', '7': 'golden_apple'
                        };
                        
                        if (seedMap[seedType]) {
                            await plantSeed(plotId, seedMap[seedType]);
                        }
                    }
                } else if (plot.status === 'ready') {
                    // –°–æ–±—Ä–∞—Ç—å —É—Ä–æ–∂–∞–π
                    await harvestPlot(plotId);
                }
            } catch (error) {
                tg.showAlert('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É—á–∞—Å—Ç–∫–∞');
            }
        }

        // –ü–æ—Å–∞–¥–∫–∞ —Å–µ–º—è–Ω
        async function plantSeed(plotId, seedType) {
            try {
                const response = await fetch('/api/plant', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        plot_id: plotId,
                        seed_type: seedType
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    tg.showAlert('üå± –°–µ–º–µ–Ω–∞ –ø–æ—Å–∞–∂–µ–Ω—ã!');
                    loadFarm();
                } else {
                    tg.showAlert('‚ùå –û—à–∏–±–∫–∞: ' + result.message);
                }
            } catch (error) {
                tg.showAlert('‚ùå –û—à–∏–±–∫–∞ –ø–æ—Å–∞–¥–∫–∏');
            }
        }

        // –°–±–æ—Ä —É—Ä–æ–∂–∞—è
        async function harvestPlot(plotId) {
            try {
                const response = await fetch('/api/harvest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        plot_id: plotId
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    tg.showAlert('üåæ –£—Ä–æ–∂–∞–π —Å–æ–±—Ä–∞–Ω!');
                    loadFarm();
                    updateStats();
                } else {
                    tg.showAlert('‚ùå –û—à–∏–±–∫–∞: ' + result.message);
                }
            } catch (error) {
                tg.showAlert('‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∞ —É—Ä–æ–∂–∞—è');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞
        async function loadShop() {
            try {
                const response = await fetch('/api/shop');
                const shopData = await response.json();
                
                const shopItems = document.getElementById('shop-items');
                shopItems.innerHTML = '';
                
                shopData.items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'shop-item';
                    itemElement.innerHTML = `
                        <div>${item.emoji} ${item.name}</div>
                        <div>üí∞ ${item.price}</div>
                        <button onclick="buySeed('${item.type}')">–ö—É–ø–∏—Ç—å</button>
                    `;
                    shopItems.appendChild(itemElement);
                });
            } catch (error) {
                document.getElementById('shop-items').innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞</div>';
            }
        }

        // –ü–æ–∫—É–ø–∫–∞ —Å–µ–º—è–Ω
        async function buySeed(seedType) {
            try {
                const response = await fetch('/api/buy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        seed_type: seedType
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    tg.showAlert('‚úÖ –°–µ–º–µ–Ω–∞ –∫—É–ø–ª–µ–Ω—ã!');
                    updateStats();
                } else {
                    tg.showAlert('‚ùå –û—à–∏–±–∫–∞: ' + result.message);
                }
            } catch (error) {
                tg.showAlert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        async function loadInventory() {
            try {
                const response = await fetch(`/api/inventory?user_id=${userId}`);
                const inventoryData = await response.json();
                
                if (inventoryData.error) {
                    document.getElementById('inventory-items').innerHTML = `<div class="error">${inventoryData.error}</div>`;
                    return;
                }
                
                const inventoryItems = document.getElementById('inventory-items');
                inventoryItems.innerHTML = '';
                
                if (inventoryData.items.length === 0) {
                    inventoryItems.innerHTML = '<div class="loading">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</div>';
                    return;
                }
                
                inventoryData.items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'inventory-item';
                    itemElement.innerHTML = `
                        <div>${item.emoji} ${item.name}</div>
                        <div>üí∞ ${item.price}</div>
                        <div>üìè ${item.weight}g, ${item.size}cm</div>
                        <button onclick="sellItem(${item.id})">–ü—Ä–æ–¥–∞—Ç—å</button>
                    `;
                    inventoryItems.appendChild(itemElement);
                });
            } catch (error) {
                document.getElementById('inventory-items').innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è</div>';
            }
        }

        // –ü—Ä–æ–¥–∞–∂–∞ –ø—Ä–µ–¥–º–µ—Ç–∞
        async function sellItem(itemId) {
            try {
                const response = await fetch('/api/sell', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        item_id: itemId
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    tg.showAlert('üí∞ –ü—Ä–µ–¥–º–µ—Ç –ø—Ä–æ–¥–∞–Ω!');
                    loadInventory();
                    updateStats();
                } else {
                    tg.showAlert('‚ùå –û—à–∏–±–∫–∞: ' + result.message);
                }
            } catch (error) {
                tg.showAlert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–¥–∞–∂–∏');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        async function updateStats() {
            try {
                const response = await fetch(`/api/stats?user_id=${userId}`);
                const stats = await response.json();
                
                document.getElementById('money').textContent = stats.money;
                document.getElementById('level').textContent = stats.level;
                document.getElementById('inventory-count').textContent = stats.inventory_count;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–≥–æ–¥—ã
        async function updateWeather() {
            try {
                const response = await fetch('/api/weather');
                const weather = await response.json();
                
                const emoji = {
                    'sunny': '‚òÄÔ∏è',
                    'rainy': 'üåßÔ∏è',
                    'cloudy': '‚òÅÔ∏è',
                    'stormy': '‚õàÔ∏è',
                    'normal': 'üå§Ô∏è'
                }[weather.type] || 'üå§Ô∏è';
                
                document.getElementById('weather-emoji').textContent = emoji;
                document.getElementById('weather-text').textContent = weather.name;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–≥–æ–¥—ã:', error);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        if (userId) {
            loadFarm();
            updateWeather();
            updateStats();
        }

        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            if (currentTab === 'farm') {
                loadFarm();
            }
            updateWeather();
            updateStats();
        }, 30000);
    </script>
</body>
</html>
